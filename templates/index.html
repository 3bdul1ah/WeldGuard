{% extends "base.html" %}
{% block content %}
<div class="main-container">
    <div class="detection-tabs">
        <button class="tab-btn active" onclick="switchTab('live')">Live Detection</button>
        <button class="tab-btn" onclick="switchTab('upload')">Upload Image</button>
    </div>

    <div id="live" class="tab-content active">
        <div class="detection-card">
            <div class="card-header">
                <h2>Live Welding Detection</h2>
                <div class="class-badge">Real-time Analysis</div>
            </div>
            <div class="video-container">
                <img src="{{ url_for('camera_feed') }}" alt="Live Detection Feed">
            </div>
            <div class="detection-classes">
                <h3>Detection Classes:</h3>
                <div class="class-grid">
                    {% for class_name in class_names %}
                    <div class="class-item">{{ class_name }}</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <div id="upload" class="tab-content">
        <div class="detection-card">
            <div class="card-header">
                <h2>Upload Image for Detection</h2>
                <div class="class-badge">Image Analysis</div>
            </div>
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="upload-form"
                id="uploadForm">
                <div class="upload-zone" onclick="document.getElementById('file').click()">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>Drag and drop an image or click to browse</p>
                        <span class="file-types">Supported: JPG, PNG, JPEG</span>
                    </div>
                    <input type="file" name="file" id="file" accept="image/*" hidden required>
                </div>
                <div id="preview" class="image-preview" style="display: none;">
                    <img id="preview-image" src="" alt="Preview">
                    <button type="button" class="remove-btn" onclick="removeImage()">Ã—</button>
                </div>
                <button type="submit" class="submit-btn" id="submitBtn" disabled>
                    Upload and Detect
                </button>
            </form>
        </div>
    </div>
</div>

<script>
    function switchTab(tabId) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('active');
        });

        // Show selected tab
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
    }

    // File upload preview
    document.getElementById('file').addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('preview-image').src = e.target.result;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('submitBtn').disabled = false;
            }
            reader.readAsDataURL(file);
        }
    });

    function removeImage() {
        document.getElementById('file').value = '';
        document.getElementById('preview').style.display = 'none';
        document.getElementById('submitBtn').disabled = true;
    }

    // Drag and drop functionality
    const uploadZone = document.querySelector('.upload-zone');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        uploadZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        uploadZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight(e) {
        uploadZone.classList.add('highlight');
    }

    function unhighlight(e) {
        uploadZone.classList.remove('highlight');
    }

    uploadZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const file = dt.files[0];
        document.getElementById('file').files = dt.files;

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('preview-image').src = e.target.result;
                document.getElementById('preview').style.display = 'block';
                document.getElementById('submitBtn').disabled = false;
            }
            reader.readAsDataURL(file);
        }
    }
</script>
{% endblock %}